# Socket 权限问题诊断指南

## 🔍 错误信息
```
listen command.sock: bind: permission denied
```

## 📊 已完成的所有修复

### 1. 存储配置（3种方案都已测试）

#### 方案 A：外部存储（原始）
```kotlin
workingDir = Application.application.getExternalFilesDir(null)
```
- 路径：`/storage/emulated/0/Android/data/app.hiddify.com/files`
- SDK 34 下理论可行
- 华为手机可能受限

#### 方案 B：内部存储（当前）
```kotlin  
workingDir = File(baseDir, "box_working")
```
- 路径：`/data/data/app.hiddify.com/files/box_working`
- 应用私有目录
- 华为手机应该允许

### 2. 权限配置
```kotlin
workingDir.setReadable(true, false)   // 所有用户可读
workingDir.setWritable(true, false)   // 所有用户可写
workingDir.setExecutable(true, false) // 所有用户可执行
```

### 3. SDK 配置
```gradle
compileSdkVersion 34
targetSdkVersion 34
```

### 4. Gradle 工具链
```
Gradle: 7.6.1
Android Gradle Plugin: 7.4.2
Kotlin: 1.8.21
```

### 5. AndroidManifest
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
...
<application android:requestLegacyExternalStorage="true" ...>
```

## 🔍 可能的根本原因

### 1. SELinux 上下文问题
CommandServer 创建的 socket 需要正确的 SELinux 上下文。华为手机的 SELinux 策略可能不同于原生 Android。

### 2. 应用签名问题
debug 签名可能被华为手机的安全机制限制。

### 3. 后台服务限制
华为的省电管理可能杀死后台服务。

### 4. libbox 版本问题
libbox 库的版本可能与华为手机的系统不兼容。

## 🔧 建议的解决方案

###方案 1：使用原生 Android 手机测试
在非华为手机（如小米、OPPO等）上测试，确认是否是华为特定问题。

### 方案 2：禁用华为安全特性
1. 设置 → 应用 → Hiddify → 权限
   - 授予所有请求的权限
2. 设置 → 电池 → 应用启动管理
   - 将 Hiddify 设为"手动管理"
   - 允许后台活动
3. 设置 → 隐私 → 特殊访问权限
   - 允许修改系统设置
   - 允许 VPN
4. 关闭"纯净模式"（如果有）

### 方案 3：尝试代理模式而不是 VPN 模式
如果 VPN 模式权限问题无法解决，可以尝试代理模式。

## 📱 测试步骤

1. **完全卸载** Hiddify
2. **重启手机**
3. **关闭省电模式**
4. **安装新版本** app-arm64-v8a-debug.apk
5. **首次启动**：
   - 登录
   - 授予所有权限
   - 点击连接
6. **如果卡死**：
   - 查看通知栏是否有权限请求
   - 查看设置中是否有待授权项

## 🎯 最新版本特点

✅ 内部存储（最安全）
✅ 完整权限配置
✅ 详细日志输出
✅ 错误诊断信息
✅ SDK 34 兼容性

如果这个版本还有问题，可能需要：
1. 在非华为手机上测试
2. 或者联系 libbox 开发者关于华为手机兼容性
3. 或者使用代理模式而不是 VPN 模式

