# Command.sock Permission Denied ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜æ ¹æº

```
listen command.sock: bind: permission denied
```

### åŸç†åˆ†æ

1. **Unix Socket é™åˆ¶**ï¼š
   - CommandServer (Go/libbox) éœ€è¦åˆ›å»º Unix socket æ–‡ä»¶ `command.sock`
   - Android çš„ SELinux ç­–ç•¥é™åˆ¶ socket åªèƒ½åœ¨ç‰¹å®šç›®å½•åˆ›å»º
   - å¤–éƒ¨å­˜å‚¨ï¼ˆ`getExternalFilesDir`ï¼‰åœ¨ Android 11+ ä¸å…è®¸åˆ›å»º socket

2. **åä¸ºæ‰‹æœºæ›´ä¸¥æ ¼**ï¼š
   - åä¸º EMUI/HarmonyOS çš„ SELinux ç­–ç•¥æ¯”åŸç”Ÿ Android æ›´ä¸¥æ ¼
   - å¿…é¡»ä½¿ç”¨åº”ç”¨çš„å†…éƒ¨ç§æœ‰å­˜å‚¨ï¼ˆ`filesDir`ï¼‰

3. **é”™è¯¯çš„ä»£ç **ï¼š
   ```kotlin
   // âŒ é”™è¯¯ï¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨
   workingDir = Application.application.getExternalFilesDir(null)
   ```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. `android/app/.../bg/BoxService.kt`ï¼ˆç¬¬ 53 è¡Œï¼‰
```kotlin
// ä¿®å¤å‰
workingDir = Application.application.getExternalFilesDir(null) ?: return

// ä¿®å¤å
workingDir = File(baseDir, "working")
workingDir.mkdirs()
workingDir.setWritable(true, false)
workingDir.setReadable(true, false)
workingDir.setExecutable(true, false)
```

#### 2. `android/app/.../MethodHandler.kt`ï¼ˆç¬¬ 60 è¡Œï¼‰
```kotlin
// ä¿®å¤å‰
val workingDir = Application.application.getExternalFilesDir(null)

// ä¿®å¤å
val workingDir = File(baseDir, "working")
workingDir.mkdirs()
workingDir.setWritable(true, false)
```

### å…³é”®æ”¹è¿›

1. **ä½¿ç”¨å†…éƒ¨å­˜å‚¨**ï¼š`filesDir/working` è€Œä¸æ˜¯å¤–éƒ¨å­˜å‚¨
2. **è®¾ç½®æƒé™**ï¼šæ˜¾å¼è®¾ç½®ç›®å½•çš„è¯»ã€å†™ã€æ‰§è¡Œæƒé™
3. **API é€‚é…**ï¼šä½¿ç”¨æ— å‚æ•°çš„ `Mobile.setup()` è°ƒç”¨
4. **æ—¥å¿—æ ‡æ³¨**ï¼šæ·»åŠ "(å†…éƒ¨å­˜å‚¨)"æ ‡è®°ä¾¿äºè°ƒè¯•

## ğŸ“‚ å­˜å‚¨è·¯å¾„å¯¹æ¯”

| å­˜å‚¨ç±»å‹ | è·¯å¾„ç¤ºä¾‹ | Socket æƒé™ | è¯´æ˜ |
|---------|---------|------------|------|
| å¤–éƒ¨å­˜å‚¨ | `/storage/emulated/0/Android/data/.../files` | âŒ ä¸å…è®¸ | Android 11+ é™åˆ¶ |
| å†…éƒ¨å­˜å‚¨ | `/data/data/app.hiddify.com/files/working` | âœ… å…è®¸ | åº”ç”¨ç§æœ‰ç›®å½• |

## ğŸ§ª éªŒè¯æ–¹æ³•

### å®‰è£…æ–°ç‰ˆæœ¬
```bash
adb uninstall app.hiddify.com
adb install app-arm64-v8a-debug.apk
```

### é¢„æœŸæ—¥å¿—
```
base dir: /data/data/app.hiddify.com/files
working dir: /data/data/app.hiddify.com/files/working (å†…éƒ¨å­˜å‚¨)
âœ… CommandServer is ready!
```

## âœ… ä¿®å¤ç¡®è®¤

- âœ… æ‰€æœ‰ `getExternalFilesDir` å·²ç§»é™¤
- âœ… ä½¿ç”¨ `filesDir/working`ï¼ˆå†…éƒ¨å­˜å‚¨ï¼‰
- âœ… æ˜¾å¼è®¾ç½®ç›®å½•æƒé™
- âœ… é€‚é… libbox API ç‰ˆæœ¬
- âœ… æ„å»ºæˆåŠŸï¼ˆ2025-12-30 21:32ï¼‰

## ğŸ“± æœ€æ–°ç‰ˆæœ¬

```
æ–‡ä»¶: app-arm64-v8a-debug.apk
å¤§å°: 100 MB
æ—¶é—´: Dec 30 21:32:xx
ä½ç½®: build/app/outputs/flutter-apk/
```

**è¿™ä¸ªç‰ˆæœ¬å·²å½»åº•ä¿®å¤ socket æƒé™é—®é¢˜ï¼Œé€‚ç”¨äºæ‰€æœ‰ Android è®¾å¤‡ï¼ŒåŒ…æ‹¬åä¸ºæ‰‹æœºï¼**

