# 异常用户管理功能说明

## 功能概述

异常用户管理功能用于识别和管理系统中的异常用户，包括设备超限用户、长期未登录用户等。该功能帮助管理员及时发现和处理异常情况。

## 访问路径

- **管理员后台** → **用户管理** → **异常用户**

## 主要功能

### 1. 异常用户识别

系统自动识别以下异常用户：

- **设备超限用户**：订阅设备数超过限制的用户
  - 状态标记：`device_overlimit`
  - 影响：用户无法添加新设备
  - 处理：需要增加设备限制或删除多余设备

- **长期未登录用户**：长时间未登录的用户
  - 识别规则：可配置（如30天、60天、90天未登录）
  - 用途：用于用户活跃度分析

- **账户异常用户**：账户状态异常的用户
  - 已禁用但仍有活跃订阅
  - 余额异常
  - 其他异常情况

### 2. 异常用户列表

列表显示以下信息：
- **用户ID**：用户唯一标识
- **邮箱**：用户邮箱
- **用户名**：用户名
- **异常类型**：异常类型（设备超限/长期未登录等）
- **异常详情**：异常的具体信息
- **最后登录**：最后登录时间
- **操作**：可执行的操作

### 3. 异常处理操作

管理员可以对异常用户执行以下操作：

- **查看详情**：查看用户的完整信息
- **增加设备限制**：为设备超限用户增加设备限制
- **清理设备**：清理用户的设备记录
- **发送提醒**：向用户发送异常提醒邮件
- **批量处理**：批量处理多个异常用户

## 设备超限原理

### 超限识别

系统通过以下方式识别设备超限用户：

1. **检查订阅设备数**
   - 查询用户的所有订阅
   - 统计每个订阅的设备数
   - 对比设备限制

2. **标记超限状态**
   - 如果设备数 > 设备限制
   - 自动标记用户状态为 `device_overlimit`
   - 在用户列表中显示"设备超限"标签

3. **实时更新**
   - 设备数变化时自动检查
   - 状态实时更新

### 超限处理

管理员可以采取以下措施处理设备超限：

1. **增加设备限制**
   - 编辑订阅，增加设备限制
   - 用户状态自动恢复正常

2. **清理设备**
   - 清理用户的设备记录
   - 释放设备数量
   - 用户状态自动恢复正常

3. **发送提醒**
   - 向用户发送设备超限提醒
   - 告知用户处理方式

## 数据模型

### User 模型（相关字段）

```go
type User struct {
    ID          uint
    Email       string
    Username    string
    Status      string    // 状态（active/inactive/disabled/device_overlimit）
    LastLogin   sql.NullTime
    // ... 其他字段
}
```

### Subscription 模型（相关字段）

```go
type Subscription struct {
    ID              uint
    UserID          uint
    DeviceLimit     int       // 设备限制
    CurrentDevices  int       // 当前设备数
    // ... 其他字段
}
```

## API 接口

### 获取异常用户列表

```
GET /api/v1/admin/users/abnormal
```

**查询参数：**
- `page`: 页码
- `size`: 每页数量
- `type`: 异常类型筛选

**响应示例：**
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": 1,
        "email": "user@example.com",
        "username": "user",
        "abnormal_type": "device_overlimit",
        "abnormal_detail": "订阅设备数超过限制(4/3)",
        "last_login": "2025-12-20 10:00:00"
      }
    ],
    "total": 10
  }
}
```

## 使用场景

### 场景1：处理设备超限用户

1. 进入异常用户列表
2. 筛选"设备超限"类型
3. 查看超限详情
4. 选择处理方式：
   - 增加设备限制
   - 或清理设备记录
5. 用户状态自动恢复正常

### 场景2：用户活跃度分析

1. 查看长期未登录用户
2. 分析用户流失原因
3. 发送召回邮件
4. 提高用户活跃度

## 注意事项

1. **自动识别**：异常状态由系统自动识别和更新
2. **实时更新**：设备数变化时，状态会实时更新
3. **批量处理**：可以批量处理多个异常用户
4. **提醒邮件**：可以配置自动发送异常提醒邮件

## 相关功能

- [用户列表管理](./user_list_management.md)
- [订阅列表管理](./subscription_list_management.md)
- [设备管理](./device_management.md)

