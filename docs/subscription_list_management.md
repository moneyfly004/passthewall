# 订阅列表管理功能说明

## 功能概述

订阅列表管理是管理员后台的核心功能，用于管理系统中所有用户的订阅信息。该功能提供了订阅信息的查看、搜索、筛选、编辑、重置等完整操作。

## 访问路径

- **管理员后台** → **订阅管理** → **订阅列表**

## 主要功能

### 1. 订阅信息展示

列表显示以下订阅信息：
- **订阅ID**：系统自动分配的唯一标识符
- **用户信息**：用户邮箱和用户名（可点击查看用户详情）
- **订阅地址**：用户的订阅链接（支持复制）
- **设备限制**：该订阅允许的最大设备数量
- **当前设备**：当前已使用的设备数量（格式：当前数/限制数）
- **到期时间**：订阅的到期时间
- **状态**：订阅状态（正常/已过期/已禁用）
- **操作**：可执行的操作按钮

### 2. 搜索功能

- **关键词搜索**：支持通过QQ号或订阅地址进行搜索
- **状态筛选**：可按订阅状态筛选
- **到期时间筛选**：可按到期时间范围筛选
- **实时搜索**：输入关键词后自动搜索

### 3. 批量操作

支持对选中的多个订阅执行批量操作：
- **批量删除**：删除选中的订阅（会同时删除相关设备记录）
- **批量启用**：激活选中的订阅
- **批量禁用**：禁用选中的订阅
- **批量重置**：重置选中订阅的订阅地址，清除设备记录，并发送重置邮件
- **批量发送订阅邮件**：向选中订阅的用户发送订阅地址邮件

### 4. 单个订阅操作

- **查看详情**：查看订阅的完整信息
- **编辑订阅**：修改订阅信息（设备限制、到期时间、状态等）
- **重置订阅**：重置订阅地址，清除所有设备记录，发送重置邮件
- **发送订阅邮件**：向用户发送订阅地址邮件
- **快捷添加时间**：快速为订阅添加时间（+1天/+7天/+30天/+90天/+180天/+1年）
  - 如果订阅已过期：从当前时间开始计算
  - 如果订阅未过期：从现有到期时间开始计算
- **登录为用户**：以订阅所属用户身份登录系统

### 5. 排序功能

- **添加时间排序**：按订阅创建时间排序
- **到期时间排序**：按到期时间排序
- **设备数量排序**：按当前设备数量排序
- **通用订阅排序**：按通用订阅次数排序
- **在线状态排序**：按订阅活跃度排序

### 6. 导出功能

- **导出订阅**：导出所有订阅信息为CSV文件
- 包含字段：订阅ID、用户邮箱、订阅地址、设备限制、当前设备、到期时间、状态等

### 7. 列设置

- 可以自定义显示的列
- 支持显示/隐藏特定列
- 设置会保存到本地存储

## 设备数量限制原理

### 核心概念

设备数量限制是订阅管理的重要功能，用于控制每个订阅可以同时使用的设备数量。

### 设备识别机制

系统通过以下方式识别设备：

1. **设备哈希生成**
   - 基于 User-Agent、IP地址、设备ID等信息生成唯一哈希
   - 哈希算法：SHA256
   - 哈希值作为设备的唯一标识

2. **设备信息解析**
   - 从 User-Agent 中解析设备信息：
     - 软件名称（Shadowrocket、Clash、v2rayN等）
     - 软件版本
     - 操作系统（iOS、Android、Windows、macOS等）
     - 操作系统版本
     - 设备型号（iPhone 15 Pro、Samsung Galaxy等）
     - 设备品牌

3. **设备漫游机制**
   - 当同一设备在不同网络环境下（如家庭WiFi和公司WiFi）访问时
   - 系统会检查是否有相同 User-Agent 的设备
   - 如果找到，会更新该设备的IP和Hash，而不是创建新设备
   - 这解决了同一设备因IP变化被识别为多个设备的问题

### 设备限制逻辑

#### 1. 设备限制为0

- 如果 `DeviceLimit = 0`，不允许任何设备使用
- 订阅会返回错误节点配置

#### 2. 设备未超限

- 如果当前设备数 < 设备限制
- 新设备可以正常添加
- 已存在的设备可以正常使用

#### 3. 设备已超限

当设备数达到或超过限制时：

1. **检查当前设备是否存在**
   - 生成当前请求的设备哈希
   - 查询数据库中是否存在该设备

2. **如果设备不存在（新设备）**
   - 直接拒绝，返回错误节点配置
   - 错误信息：`设备数量超过限制(当前X/限制Y)，无法添加新设备`

3. **如果设备存在（已注册设备）**
   - 查询该订阅下所有活跃设备
   - 按最后访问时间降序排序
   - 取前 `DeviceLimit` 个设备作为"允许的设备"
   - 检查当前设备是否在允许的设备列表中
   - 如果在列表中：允许使用
   - 如果不在列表中：拒绝，返回错误节点配置
   - 错误信息：`设备数量超过限制(当前X/限制Y)，此设备不在允许范围内`

### 设备优先级机制

当设备数超过限制时，系统采用"最近使用优先"的策略：

1. **排序规则**：按 `last_access`（最后访问时间）降序排序
2. **允许列表**：取前 `DeviceLimit` 个设备
3. **动态更新**：每次设备访问时，都会更新 `last_access` 时间
4. **自动淘汰**：长时间未使用的设备会被自动排除在允许列表外

### 设备记录流程

```
用户请求订阅
    ↓
检查订阅有效性（过期、禁用等）
    ↓
生成设备哈希
    ↓
检查设备是否存在
    ↓
如果不存在：
    ├─ 检查是否有相同UA的设备（设备漫游）
    │   ├─ 找到：更新该设备的IP和Hash
    │   └─ 未找到：检查设备数是否超限
    │       ├─ 未超限：创建新设备记录
    │       └─ 已超限：不创建记录，返回错误节点
    └─ 如果存在：更新设备的访问时间和IP
    ↓
检查设备数是否超限
    ↓
如果超限：
    ├─ 查询允许的设备列表（按最后访问时间排序，取前N个）
    ├─ 检查当前设备是否在允许列表中
    │   ├─ 在列表中：允许使用，生成正常配置
    │   └─ 不在列表中：拒绝，返回错误节点
    └─ 如果未超限：允许使用，生成正常配置
```

### 设备状态管理

- **is_active**：设备是否活跃
  - `true`：设备活跃，计入设备数
  - `false`：设备已禁用，不计入设备数

- **is_allowed**：设备是否被允许使用
  - `true`：设备被允许使用
  - `false`：设备被禁止使用（管理员手动禁用）

### 设备清理

管理员可以执行以下操作清理设备：

1. **清理单个订阅的设备**
   - 在订阅列表中点击"清理设备"按钮
   - 会清除该订阅的所有设备记录
   - 设备数重置为0

2. **批量清理设备**
   - 选中多个订阅
   - 点击"清理设备数"按钮
   - 批量清除选中订阅的设备记录

3. **重置订阅**
   - 重置订阅地址时，会自动清除所有设备记录
   - 用户需要重新添加设备

## 数据模型

### Subscription 模型

```go
type Subscription struct {
    ID              uint
    UserID          uint
    PackageID       *int64
    SubscriptionURL string
    DeviceLimit     int       // 设备限制（默认3）
    CurrentDevices  int       // 当前设备数（自动计算）
    UniversalCount  int       // 通用订阅次数
    ClashCount      int       // Clash订阅次数
    IsActive        bool
    Status          string    // active/expired/disabled
    ExpireTime      time.Time
    CreatedAt       time.Time
    UpdatedAt       time.Time
}
```

### Device 模型

```go
type Device struct {
    ID                uint
    UserID            *int64
    SubscriptionID    uint
    DeviceHash        *string    // 设备哈希（唯一标识）
    DeviceUA          *string    // User-Agent
    DeviceName        *string    // 设备名称
    DeviceType        *string    // 设备类型（mobile/desktop/tablet）
    IPAddress         *string    // IP地址
    UserAgent         *string    // 完整User-Agent
    SoftwareName      *string    // 软件名称
    SoftwareVersion   *string    // 软件版本
    OSName            *string    // 操作系统
    OSVersion         *string    // 操作系统版本
    IsActive          bool       // 是否活跃
    IsAllowed         bool       // 是否允许使用
    LastAccess        time.Time  // 最后访问时间（用于排序）
    AccessCount       int        // 访问次数
    CreatedAt         time.Time
    UpdatedAt         time.Time
}
```

## API 接口

### 获取订阅列表

```
GET /api/v1/admin/subscriptions
```

**查询参数：**
- `page`: 页码
- `size`: 每页数量
- `keyword`: 搜索关键词（QQ或订阅地址）
- `status`: 状态筛选
- `start_date`: 开始日期
- `end_date`: 结束日期

### 批量操作接口

```
POST /api/v1/admin/subscriptions/batch-delete
POST /api/v1/admin/subscriptions/batch-enable
POST /api/v1/admin/subscriptions/batch-disable
POST /api/v1/admin/subscriptions/batch-reset
POST /api/v1/admin/subscriptions/batch-send-email
```

## 使用场景

### 场景1：查看设备超限的订阅

1. 在列表中查看"当前设备"列
2. 如果显示为"3/3"或"4/3"等，说明设备已超限
3. 可以点击"重置订阅"清除设备，或增加设备限制

### 场景2：批量重置订阅

1. 选中需要重置的订阅
2. 点击"批量重置"按钮
3. 系统会：
   - 生成新的订阅地址
   - 清除所有设备记录
   - 向用户发送重置邮件

### 场景3：快速续费

1. 找到需要续费的订阅
2. 点击"快捷添加时间"按钮
3. 选择要添加的时间（如"+1年"）
4. 系统自动计算新的到期时间

## 注意事项

1. **设备限制为0**：如果设置为0，订阅将无法使用，请谨慎设置
2. **重置订阅**：重置会清除所有设备记录，用户需要重新添加设备
3. **设备超限处理**：系统采用"最近使用优先"策略，长时间未使用的设备会被自动排除
4. **设备漫游**：同一设备在不同网络环境下访问时，系统会自动识别为同一设备
5. **批量操作**：批量操作会影响多个订阅，请确认后再执行

## 相关功能

- [设备管理](./device_management.md)
- [用户列表管理](./user_list_management.md)
- [节点管理](./node_management.md)

