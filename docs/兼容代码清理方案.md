# 兼容代码清理方案

## 一、配置键兼容（优先级：高）

### 1.1 `urls` vs `node_source_urls`（已提供迁移脚本）

**位置**：
- `internal/services/config_update/config_update.go` - `getConfig()` 方法（第 738-767 行）
- `internal/api/handlers/subscription_config.go` - `GetConfigUpdateConfig()` 方法（第 492-543 行）
- `internal/api/handlers/subscription_config.go` - `UpdateConfigUpdateConfig()` 方法（第 624-657 行）
- `internal/api/handlers/node.go` - 第 682、701 行

**问题**：同时支持两种配置键，代码复杂且容易混淆

**清理方案**：
1. ✅ 已创建迁移脚本：`scripts/migrate_config_keys.go`
2. 移除所有对 `node_source_urls` 的引用
3. 统一使用 `urls` 配置键

**影响文件**：
- `internal/services/config_update/config_update.go`
- `internal/api/handlers/subscription_config.go`
- `internal/api/handlers/node.go`

---

## 二、配置查找兼容（优先级：中）

### 2.1 `support_qq` 和 `support_email` 配置查找

**位置**：
- `internal/services/config_update/config_update.go` - `refreshSystemConfig()` 方法（第 470-479 行）
- `internal/api/handlers/config.go` - `GetAdminSettings()` 方法（第 460-482 行）

**问题**：先查找 `category = "general"`，找不到再查找任意 category

**清理方案**：
1. 统一为只查找 `category = "general"`
2. 如果找不到，返回空值（不查找其他 category）
3. 运行数据迁移，将所有 `support_qq` 和 `support_email` 配置统一到 `category = "general"`

**影响文件**：
- `internal/services/config_update/config_update.go`
- `internal/api/handlers/config.go`

### 2.2 `domain_name`、`site_url`、`base_url` 配置查找

**位置**：
- `internal/services/config_update/config_update.go` - `refreshSystemConfig()` 方法（第 453-466 行）
- `internal/services/email/templates.go` - `getBaseURL()` 方法（第 36-56 行）

**问题**：支持多种配置键：`domain_name`（优先）→ `site_url` → `base_url`

**清理方案**：
1. 统一为只使用 `domain_name`（`category = "general"`）
2. 运行数据迁移，将 `site_url` 和 `base_url` 的值迁移到 `domain_name`
3. 移除对 `site_url` 和 `base_url` 的查找逻辑

**影响文件**：
- `internal/services/config_update/config_update.go`
- `internal/services/email/templates.go`

---

## 三、API 路由别名（优先级：低）

### 3.1 认证相关路由别名

**位置**：`internal/api/router/router.go`

**别名列表**：
- `/auth/login-json` - 兼容前端管理员/用户登录（第 55 行）
- `/auth/forgot-password-new` - 别名，兼容前端（第 62 行）
- `/auth/reset-password-new` - 别名，兼容前端（第 64 行）

**清理方案**：
1. 确认前端是否仍在使用这些路径
2. 如果不再使用，可以移除
3. 如果仍在使用，建议保留（不影响功能）

### 3.2 用户相关路由别名

**位置**：`internal/api/router/router.go`

**别名列表**：
- `/users/profile` - 别名，兼容前端（第 72、74 行）
- `/users/preference-settings` - 别名，兼容前端（第 78 行）

**清理方案**：同上

### 3.3 订阅相关路由别名

**位置**：`internal/api/router/router.go`

**别名列表**：
- `/subscriptions/ssr/:url` - 兼容旧路径（第 116 行）
- `/subscriptions/v2ray/:url` - 兼容旧路径（第 117 行）

**清理方案**：同上

### 3.4 其他路由别名

**位置**：`internal/api/router/router.go`

**别名列表**：
- `/orders/create` - 别名，兼容前端（第 126 行）
- `/notifications/:id/read` - 兼容前端可能使用 POST（第 205 行）
- `/notifications/mark-all-read` - 兼容前端（第 207 行）
- `/tickets/:id/replies` - 兼容前端调用（第 231 行）
- `/invites/generate` - 兼容旧路径（第 261 行）
- `/recharge/create` - 别名，兼容前端（第 276 行）
- `/admin/system-logs` - 兼容前端API（第 514 行）

**清理方案**：同上

---

## 四、旧订阅地址处理（优先级：中低）

### 4.1 `OldSubscriptionURL` 字段和逻辑

**位置**：
- `internal/models/subscription.go` - `OldSubscriptionURL` 字段（第 42 行）
- `internal/api/handlers/subscription_config.go` - `checkOldSubscriptionURL()` 函数（第 83-88 行）
- `internal/services/config_update/config_update.go` - `StatusOldAddress` 状态（第 37、1213-1214、1477 行）
- `internal/api/handlers/subscription.go` - 多处使用（第 365-382、443-460、520-538、931-952 行）

**问题**：用于处理订阅重置时的旧地址兼容

**清理方案**：
1. **建议保留**：这是业务功能，不是兼容代码
2. 如果确实要清理，需要：
   - 移除 `OldSubscriptionURL` 字段
   - 移除所有相关逻辑
   - 确保订阅重置功能正常工作

**影响文件**：
- `internal/models/subscription.go`
- `internal/api/handlers/subscription_config.go`
- `internal/services/config_update/config_update.go`
- `internal/api/handlers/subscription.go`

---

## 五、数据库表结构迁移（优先级：保留）

### 5.1 `custom_nodes` 表结构迁移

**位置**：`internal/core/database/database.go` - `AutoMigrate()` 方法（第 115-180 行）

**问题**：检测旧版表结构并自动迁移

**清理方案**：
- **必须保留**：这是必要的数据库升级逻辑，不能移除

---

## 六、其他兼容代码（优先级：低）

### 6.1 保留的旧函数

**位置**：
- `internal/services/config_update/config_update.go` - `importNodesToDatabase()` 函数（第 1109 行）
  - 注释：`// importNodesToDatabase 将节点导入到数据库的 nodes 表（保留旧函数以兼容）`
- `internal/services/config_update/config_update.go` - `UpdateSubscriptionConfig()` 函数（第 1277 行）
  - 注释：`// UpdateSubscriptionConfig 更新订阅配置 (保留兼容)`

**清理方案**：
1. 检查是否有其他地方调用这些函数
2. 如果没有调用，可以移除
3. 如果有调用，需要先替换调用处

### 6.2 向后兼容的请求绑定

**位置**：
- `internal/api/handlers/config.go` - `UpdateSystemConfig()` 方法（第 164-165 行）
  - 注释：`// 如果绑定失败，尝试只绑定 value（向后兼容）`

**清理方案**：
1. 确认前端是否仍在使用旧格式
2. 如果不再使用，可以移除

### 6.3 兼容字段名

**位置**：
- `internal/api/handlers/user.go` - 第 1185 行：`"token": accessToken, // 兼容前端期望的字段名`
- `internal/api/handlers/user_profile.go` - 第 217-223 行：多个兼容字段
- `internal/api/handlers/order.go` - 第 199、551-552、565 行：多个兼容字段
- `internal/api/handlers/package.go` - 第 351 行：`"items": formattedPackages, // 兼容前端可能使用的 items 字段`
- `internal/api/handlers/password.go` - 第 23、49-52 行：`OldPassword` 字段兼容

**清理方案**：
1. 确认前端是否仍在使用这些字段名
2. 如果不再使用，可以移除
3. 如果仍在使用，建议保留（不影响功能）

---

## 七、清理优先级建议

### 高优先级（立即执行）
1. ✅ **配置键统一**：`urls` vs `node_source_urls`
   - 已提供迁移脚本
   - 影响代码清晰度

### 中优先级（后续执行）
2. **配置查找统一**：`support_qq`、`support_email`、`domain_name` 等
   - 需要数据迁移
   - 影响代码维护性

### 低优先级（可选）
3. **API 路由别名**
   - 不影响功能
   - 可以保留以兼容前端

4. **兼容字段名**
   - 不影响功能
   - 可以保留以兼容前端

### 必须保留
5. **数据库表结构迁移逻辑**
   - 这是必要的升级处理
   - 不能移除

6. **旧订阅地址处理**
   - 这是业务功能
   - 不是兼容代码

---

## 八、执行步骤

### 步骤 1：配置键统一（高优先级）

1. 运行迁移脚本：
   ```bash
   go run scripts/migrate_config_keys.go
   ```

2. 修改代码，移除 `node_source_urls` 兼容逻辑：
   - `internal/services/config_update/config_update.go` - `getConfig()` 方法
   - `internal/api/handlers/subscription_config.go` - `GetConfigUpdateConfig()` 和 `UpdateConfigUpdateConfig()` 方法
   - `internal/api/handlers/node.go` - 相关引用

### 步骤 2：配置查找统一（中优先级）

1. 创建数据迁移脚本，统一配置的 category：
   - 将所有 `support_qq` 和 `support_email` 配置迁移到 `category = "general"`
   - 将 `site_url` 和 `base_url` 的值迁移到 `domain_name`（`category = "general"`）

2. 修改代码，移除兼容查找逻辑：
   - `internal/services/config_update/config_update.go` - `refreshSystemConfig()` 方法
   - `internal/api/handlers/config.go` - `GetAdminSettings()` 方法
   - `internal/services/email/templates.go` - `getBaseURL()` 方法

### 步骤 3：其他清理（低优先级）

1. 确认前端是否仍在使用旧 API 路径和字段名
2. 如果不再使用，可以移除相关兼容代码
3. 如果仍在使用，建议保留

---

## 九、风险评估

| 清理项 | 风险等级 | 影响范围 | 建议 |
|--------|---------|---------|------|
| `urls` vs `node_source_urls` | 低 | 配置管理 | 立即执行 |
| 配置查找兼容 | 中 | 系统配置 | 后续执行 |
| API 路由别名 | 低 | API 调用 | 可选清理 |
| 兼容字段名 | 低 | API 响应 | 可选清理 |
| 数据库迁移逻辑 | 高 | 数据库升级 | 必须保留 |
| 旧订阅地址处理 | 中 | 业务功能 | 建议保留 |

---

## 十、总结

**主要兼容代码类型**：
1. 配置键重复（`urls` vs `node_source_urls`）- **最优先清理**
2. 配置查找兼容（多 category 查找）- **后续清理**
3. API 路由别名 - **可选清理**
4. 兼容字段名 - **可选清理**
5. 数据库迁移逻辑 - **必须保留**
6. 旧订阅地址处理 - **业务功能，建议保留**

**建议执行顺序**：
1. 先清理配置键兼容（已提供迁移脚本）
2. 再清理配置查找兼容（需要数据迁移）
3. 最后考虑清理 API 路由别名和兼容字段名（需要确认前端使用情况）

