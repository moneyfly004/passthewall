# 专线节点搭建完整教程

## 目录
1. [概述](#概述)
2. [前置准备](#前置准备)
3. [系统设置配置](#系统设置配置)
4. [添加服务器](#添加服务器)
5. [自动安装XrayR](#自动安装xrayr)
6. [创建专线节点](#创建专线节点)
7. [分配节点给用户](#分配节点给用户)
8. [常见问题](#常见问题)

---

## 概述

专线节点功能允许您：
- 管理多个VPS服务器
- 自动安装和配置XrayR
- 自动申请SSL证书（使用Cloudflare）
- 创建自定义节点并分配给特定用户
- 控制节点的流量和到期时间

---

## 前置准备

### 1. 准备VPS服务器

确保您有：
- ✅ 一台或多台VPS服务器（支持Ubuntu/Debian/CentOS）
- ✅ 服务器的SSH访问权限（IP地址、端口、用户名、密码）
- ✅ 服务器已开放必要的端口（SSH端口、节点端口）

### 2. 准备Cloudflare账号（可选，用于域名和证书）

如果需要使用域名和自动申请SSL证书，需要：
- ✅ Cloudflare账号
- ✅ 域名已添加到Cloudflare
- ✅ Cloudflare API Token 或 API Key + Email

**获取Cloudflare API Token：**
1. 登录 Cloudflare 控制台
2. 进入 "My Profile" → "API Tokens"
3. 点击 "Create Token"
4. 选择 "Edit zone DNS" 模板
5. 选择要管理的域名
6. 创建并复制Token

**获取Cloudflare API Key：**
1. 进入 "My Profile" → "API Tokens"
2. 在 "Global API Key" 部分查看并复制

### 3. 准备邮箱（用于Let's Encrypt证书）

- ✅ 一个有效的邮箱地址（用于接收Let's Encrypt证书通知）

---

## 系统设置配置

### 步骤1：进入系统设置

1. 登录管理后台
2. 点击左侧菜单 "系统管理" → "系统设置"
3. 切换到 "专线节点设置" 标签页

### 步骤2：配置XrayR API（可选，系统会自动配置）

如果您已经手动安装了XrayR，可以填写：
- **XrayR API 地址**：例如 `http://your-server-ip:10086`
- **XrayR API 密钥**：XrayR配置文件中的ApiKey

> **注意**：如果您使用"自动设置XrayR"功能，这些配置会自动填写，无需手动输入。

### 步骤3：配置Cloudflare API（可选，用于域名和证书）

如果需要使用域名和自动申请证书：

1. **Cloudflare API Token**（推荐）：
   - 填写您获取的API Token
   - 如果使用Token，不需要填写API Key和Email

2. **或使用 API Key + Email**：
   - **Cloudflare API Key**：填写Global API Key
   - **Cloudflare 邮箱**：填写Cloudflare注册邮箱

### 步骤4：配置证书申请邮箱

- **证书申请邮箱**：填写用于Let's Encrypt证书申请的邮箱地址

### 步骤5：保存设置

点击 "保存专线节点设置" 按钮，系统会保存所有配置。

---

## 添加服务器

### 步骤1：进入服务器管理

1. 点击左侧菜单 "用户管理" → "服务器管理"

### 步骤2：添加服务器

1. 点击 "添加服务器" 按钮
2. 填写服务器信息：
   - **服务器名称**：给服务器起个名字，例如 "美国VPS-1"
   - **服务器地址**：服务器的IP地址或域名
   - **SSH端口**：SSH连接端口（默认22）
   - **用户名**：SSH登录用户名（通常是root）
   - **密码**：SSH登录密码
   - **状态**：选择 "活跃" 或 "非活跃"
3. 点击 "保存"

> **安全提示**：服务器密码会使用AES加密存储，确保安全。

### 步骤3：测试服务器连接

1. 在服务器列表中，找到刚添加的服务器
2. 点击 "测试连接" 按钮
3. 等待测试完成，确认连接成功

---

## 自动安装XrayR

### 方法1：使用自动设置功能（推荐）

这是最简单的方式，系统会自动完成所有步骤：

1. 在服务器列表中，找到要安装XrayR的服务器
2. 点击 "自动设置XrayR" 按钮
3. 确认操作提示
4. 系统会自动执行：
   - ✅ 检测XrayR是否已安装
   - ✅ 如果未安装，自动安装XrayR
   - ✅ 自动配置XrayR（生成API密钥）
   - ✅ 自动获取配置并填写到系统设置

5. 等待几秒钟后，刷新页面
6. 检查 "XrayR状态" 列，应该显示 "已安装"
7. 前往 "系统设置" → "专线节点设置"，确认XrayR API地址和密钥已自动填写

### 方法2：手动安装（高级用户）

如果您想手动安装XrayR：

1. SSH连接到服务器
2. 执行安装命令：
   ```bash
   bash <(curl -Ls https://raw.githubusercontent.com/XrayR-project/XrayR-release/master/install.sh)
   ```
3. 配置XrayR：
   - 编辑配置文件：`/etc/XrayR/config.yml`
   - 设置ApiHost和ApiKey
4. 重启XrayR服务：
   ```bash
   systemctl restart XrayR
   ```
5. 在管理后台点击 "获取配置" 按钮，系统会自动读取配置

---

## 创建专线节点

### 步骤1：进入专线节点管理

1. 点击左侧菜单 "用户管理" → "专线节点管理"

### 步骤2：创建节点

1. 点击 "创建专线节点" 按钮
2. 填写节点信息：

   **基本信息：**
   - **服务器**：选择要使用的服务器
   - **节点名称**：给节点起个名字，例如 "美国专线-1"
   - **协议类型**：选择 VMess、VLESS、Trojan 或 Shadowsocks

   **连接配置：**
   - **域名**（可选）：如果使用域名，填写域名地址
   - **端口**：节点端口（可以点击"随机生成"按钮自动生成）
   - **UUID**（VMess/VLESS）：可以点击"随机生成"按钮自动生成
   - **密码**（Trojan/SS）：可以点击"随机生成"按钮自动生成

   **传输协议：**
   - **传输协议**：选择 TCP、WebSocket 或 gRPC
   - **安全设置**：选择 TLS、Reality 或 None
   - **SNI**（TLS/Reality）：如果使用TLS，填写SNI

   **限制设置：**
   - **流量限制**：设置流量限制（GB），0表示无限制
   - **到期时间**（可选）：设置节点到期时间
   - **遵循用户到期**：开启后，节点到期时间将跟随用户订阅到期时间

3. 点击 "保存"

### 步骤3：等待节点创建完成

节点创建是异步进行的，系统会自动：
- ✅ 创建Cloudflare DNS记录（如果使用域名）
- ✅ 申请SSL证书（如果使用域名）
- ✅ 上传证书到服务器
- ✅ 在XrayR中创建节点
- ✅ 保存节点配置到数据库

创建完成后，节点状态会变为 "活跃"。

---

## 分配节点给用户

### 方法1：在用户详情中分配

1. 进入 "用户管理" → "用户列表"
2. 找到要分配节点的用户，点击 "详情"
3. 在用户详情对话框中，切换到 "专线节点分配" 标签页
4. 在 "分配新专线节点" 下拉框中选择要分配的节点
5. 点击 "分配" 按钮

### 方法2：查看已分配的节点

在用户详情中，可以看到：
- 已分配给该用户的所有专线节点
- 节点信息（名称、协议等）
- 可以点击 "移除" 按钮取消分配

### 节点在用户端的显示

- 专线节点会在用户的订阅中显示
- 节点名称会自动添加 "专线定制-" 前缀
- 用户可以在线路列表中看到专线节点

---

## 常见问题

### Q1: 自动设置XrayR失败怎么办？

**可能原因：**
- 服务器SSH连接失败
- 服务器没有网络访问权限
- 服务器系统不支持

**解决方法：**
1. 检查服务器SSH连接是否正常（使用"测试连接"功能）
2. 确认服务器可以访问外网（需要下载XrayR安装脚本）
3. 检查服务器系统版本（推荐Ubuntu 18.04+、Debian 9+、CentOS 7+）
4. 查看系统日志获取详细错误信息

### Q2: 证书申请失败怎么办？

**可能原因：**
- Cloudflare API配置错误
- 域名DNS记录未正确配置
- 域名未添加到Cloudflare

**解决方法：**
1. 检查Cloudflare API Token或Key是否正确
2. 确认域名已在Cloudflare中
3. 检查DNS记录是否正确创建
4. 等待DNS传播（可能需要几分钟）

### Q3: 节点创建后无法使用？

**检查清单：**
- ✅ 节点状态是否为 "活跃"
- ✅ 服务器XrayR服务是否正常运行
- ✅ 节点端口是否已开放防火墙
- ✅ 节点配置是否正确（UUID、密码等）
- ✅ 用户是否已分配该节点

### Q4: 如何更新节点配置？

1. 在专线节点列表中，点击 "编辑" 按钮
2. 修改需要更新的配置
3. 点击 "保存"
4. 系统会自动更新XrayR中的节点配置

### Q5: 如何删除节点？

1. 在专线节点列表中，点击 "删除" 按钮
2. 确认删除操作
3. 系统会自动：
   - 从XrayR中删除节点
   - 删除Cloudflare DNS记录（如果使用域名）
   - 从数据库中删除节点记录

### Q6: 如何查看节点流量？

1. 在专线节点列表中，点击 "流量" 按钮
2. 查看流量统计：
   - 流量限制
   - 已使用流量
   - 剩余流量
   - 流量日志

### Q7: 节点流量超限或过期怎么办？

- 流量超限或过期的节点会自动从用户订阅中移除
- 用户无法使用已超限或过期的节点
- 管理员可以在节点列表中查看状态

### Q8: 如何批量管理节点？

目前支持：
- 按状态筛选节点
- 按激活状态筛选节点
- 搜索节点名称
- 批量操作功能正在开发中

---

## 最佳实践

### 1. 服务器管理
- 定期测试服务器连接状态
- 为不同地区的服务器使用不同的命名规则
- 记录服务器的用途和配置信息

### 2. 节点配置
- 使用随机生成的端口、UUID和密码，确保安全
- 为不同类型的用户创建不同配置的节点
- 合理设置流量限制，避免滥用

### 3. 证书管理
- 使用Cloudflare API Token而不是API Key（更安全）
- 定期检查证书到期时间
- 确保证书申请邮箱有效

### 4. 用户分配
- 根据用户需求合理分配节点
- 定期检查节点使用情况
- 及时移除不再需要的节点分配

---

## 技术支持

如果遇到问题：
1. 查看系统日志获取详细错误信息
2. 检查服务器日志：`/var/log/XrayR/error.log`
3. 联系技术支持并提供：
   - 错误信息
   - 操作步骤
   - 系统日志

---

## 更新日志

- **v1.0.0** (2024-01-XX)
  - 初始版本
  - 支持自动安装XrayR
  - 支持自动申请SSL证书
  - 支持节点流量和到期时间控制

---

**祝您使用愉快！**


