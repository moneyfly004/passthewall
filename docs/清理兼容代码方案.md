# 清理兼容旧版代码方案

## 问题分析

代码中存在大量兼容旧版的代码，主要原因：

1. **配置键重复**：`urls` 和 `node_source_urls` 两种配置键同时存在
2. **数据库迁移**：旧版本数据库表结构需要兼容
3. **API 路由别名**：为了兼容前端可能使用的不同路径
4. **配置查找兼容**：先查特定 category，再查任意 category

## 为什么需要兼容代码？

1. **向后兼容**：旧版本数据库可能使用旧格式的数据
2. **平滑升级**：避免版本升级导致数据丢失或功能不可用
3. **前端兼容**：前端可能还在使用旧的 API 路径

## 统一方案

### 1. 配置键统一（最优先）

**问题**：`urls` 和 `node_source_urls` 两种配置键同时存在

**解决方案**：
1. 运行迁移脚本 `scripts/migrate_config_keys.go`，将 `node_source_urls` 合并到 `urls`
2. 移除代码中所有对 `node_source_urls` 的引用
3. 只保留 `urls` 配置键

**影响文件**：
- `internal/services/config_update/config_update.go` - `getConfig()` 方法
- `internal/api/handlers/subscription_config.go` - `GetConfigUpdateConfig()` 和 `UpdateConfigUpdateConfig()` 方法

### 2. 移除兼容代码步骤

#### 步骤 1：运行数据库迁移
```bash
go run scripts/migrate_config_keys.go
```

#### 步骤 2：修改代码，移除 `node_source_urls` 兼容逻辑

**修改 `config_update.go` 的 `getConfig()` 方法**：
- 移除 `nodeSourceUrlsConfig` 变量
- 移除对 `node_source_urls` 的查找和兼容逻辑
- 只使用 `urls` 配置

**修改 `subscription_config.go` 的 `UpdateConfigUpdateConfig()` 方法**：
- 移除同时更新 `node_source_urls` 的逻辑（第 643-656 行）

**修改 `subscription_config.go` 的 `GetConfigUpdateConfig()` 方法**：
- 移除 `nodeSourceUrlsConfig` 变量
- 移除对 `node_source_urls` 的查找和兼容逻辑
- 只使用 `urls` 配置

#### 步骤 3：测试验证
1. 确保配置读取正常
2. 确保配置保存正常
3. 确保节点采集功能正常

### 3. 其他兼容代码（可选清理）

#### API 路由别名
- 这些别名不影响功能，可以保留
- 如果确定前端不再使用旧路径，可以移除

#### 数据库表结构迁移
- 这些是必要的，用于处理旧版本数据库升级
- 建议保留

#### 配置查找兼容
- 如 `support_qq` 的查找逻辑
- 可以统一为只查找特定 category，如果找不到则返回空

## 执行建议

1. **先运行迁移脚本**，统一数据库中的配置键
2. **逐步移除兼容代码**，每次修改后充分测试
3. **保留必要的兼容代码**（如数据库迁移逻辑）
4. **更新文档**，说明新的配置方式

## 风险评估

- **低风险**：配置键统一（已有迁移脚本）
- **中风险**：移除 API 路由别名（需要确认前端不再使用）
- **高风险**：移除数据库迁移逻辑（可能导致旧版本升级失败）

## 建议

1. **立即执行**：配置键统一（`urls` vs `node_source_urls`）
2. **后续考虑**：API 路由别名清理
3. **保留**：数据库迁移逻辑（这是必要的）

