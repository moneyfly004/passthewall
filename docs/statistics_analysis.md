# 数据分析功能说明

## 功能概述

数据分析功能为管理员提供系统数据的统计和分析，包括用户统计、收入统计、地区分析等。该功能帮助管理员了解系统运营情况，做出数据驱动的决策。

## 访问路径

- **管理员后台** → **数据分析**

## 主要功能

### 1. 数据概览

页面顶部显示关键数据概览：
- **总用户数**：系统中的用户总数
- **活跃用户数**：最近30天登录的用户数
- **总订阅数**：系统中的订阅总数
- **活跃订阅数**：当前有效的订阅数
- **总收入**：所有订单的总收入
- **今日收入**：今日的订单收入

### 2. 用户统计

- **用户增长趋势**：按时间显示用户注册趋势
- **用户状态分布**：活跃/待激活/禁用用户的比例
- **用户等级分布**：不同等级用户的数量和占比

### 3. 收入统计

- **收入趋势**：按时间显示收入趋势
- **支付方式分布**：不同支付方式的收入占比
- **套餐销售统计**：各套餐的销售情况

### 4. 地区分析

#### 地区分布统计

- **地区分布图**：以饼图或柱状图显示用户地区分布
- **地区统计列表**：显示各地区的用户数、占比、登录次数
- **地区详细统计**：显示各国家/城市的详细统计信息

#### 地区数据来源

系统从以下数据源获取地区信息：

1. **登录历史记录**
   - 从 `login_history` 表中获取
   - 包含IP地址和地理位置信息

2. **用户活动记录**
   - 从 `user_activities` 表中获取
   - 包含用户活动的IP和地理位置

3. **审计日志**
   - 从 `audit_logs` 表中获取
   - 包含系统操作的IP和地理位置

#### 地区解析方式

1. **直接获取**
   - 如果记录中已有 `location` 字段
   - 直接使用存储的地理位置信息

2. **GeoIP解析**
   - 如果记录中没有 `location` 字段
   - 使用GeoIP数据库解析IP地址
   - 获取国家、城市等信息

3. **数据聚合**
   - 按国家、城市聚合数据
   - 统计用户数、登录次数等

### 5. 订阅统计

- **订阅状态分布**：正常/已过期/已禁用订阅的比例
- **订阅增长趋势**：按时间显示订阅增长趋势
- **设备使用统计**：平均设备使用率、设备超限情况

### 6. 订单统计

- **订单状态分布**：待支付/已支付/已取消订单的比例
- **订单趋势**：按时间显示订单趋势
- **平均订单金额**：计算平均订单金额

## 地区分析原理

### 数据收集

系统在以下场景收集地区信息：

1. **用户登录**
   - 记录登录IP地址
   - 使用GeoIP解析地理位置
   - 保存到 `login_history` 表

2. **用户活动**
   - 记录活动IP地址
   - 使用GeoIP解析地理位置
   - 保存到 `user_activities` 表

3. **系统操作**
   - 记录操作IP地址
   - 使用GeoIP解析地理位置
   - 保存到 `audit_logs` 表

### 数据聚合

系统按以下方式聚合地区数据：

1. **按国家聚合**
   - 统计每个国家的用户数
   - 统计每个国家的登录次数
   - 计算占比

2. **按城市聚合**
   - 统计每个城市的用户数
   - 统计每个城市的登录次数
   - 显示最后登录时间

3. **地区去重**
   - 同一用户在不同地区登录，按用户去重
   - 统计不同地区的用户数

### 数据展示

1. **饼图展示**
   - 以饼图显示地区分布
   - 显示各地区的占比

2. **列表展示**
   - 以表格显示详细统计
   - 包含用户数、登录次数、占比等

3. **排序功能**
   - 按用户数排序
   - 按登录次数排序
   - 按占比排序

## 数据模型

### AuditLog 模型（相关字段）

```go
type AuditLog struct {
    ID          uint
    UserID      sql.NullInt64
    ActionType  string
    IPAddress   sql.NullString
    Location    sql.NullString  // 地理位置（JSON格式）
    Referer     sql.NullString  // 来源页面
    CreatedAt   time.Time
}
```

### UserActivity 模型（相关字段）

```go
type UserActivity struct {
    ID          uint
    UserID      uint
    ActivityType string
    IPAddress   sql.NullString
    Location    sql.NullString  // 地理位置
    CreatedAt   time.Time
}
```

## API 接口

### 获取地区统计

```
GET /api/v1/admin/statistics/regions
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "region_stats": [
      {
        "region": "中国",
        "userCount": 100,
        "percentage": 50.0,
        "loginCount": 500
      }
    ],
    "region_details": [
      {
        "country": "中国",
        "city": "北京",
        "userCount": 50,
        "loginCount": 250,
        "lastLogin": "2025-12-22 10:00:00"
      }
    ]
  }
}
```

### 获取数据概览

```
GET /api/v1/admin/dashboard
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "total_users": 1000,
    "active_users": 800,
    "total_subscriptions": 500,
    "active_subscriptions": 450,
    "total_revenue": 50000.00,
    "today_revenue": 1000.00
  }
}
```

## 使用场景

### 场景1：查看用户地区分布

1. 进入数据分析页面
2. 切换到"地区分析"标签
3. 查看地区分布饼图
4. 了解用户主要来自哪些地区
5. 查看详细统计列表

### 场景2：分析用户增长

1. 查看用户增长趋势图
2. 分析用户注册的时间分布
3. 识别用户增长的高峰期
4. 制定相应的营销策略

### 场景3：收入分析

1. 查看收入趋势图
2. 分析收入的时间分布
3. 查看支付方式分布
4. 了解哪种支付方式更受欢迎

## 注意事项

1. **GeoIP数据库**：需要下载GeoIP数据库才能准确显示地区信息
2. **数据更新**：统计数据不是实时的，可能需要刷新才能看到最新数据
3. **数据准确性**：地区信息基于IP地址解析，可能存在一定误差
4. **隐私保护**：地区信息已做聚合处理，不会泄露具体用户信息

## 相关功能

- [GeoIP集成说明](./GeoIP集成说明.md)
- [用户列表管理](./user_list_management.md)
- [登录历史管理](./login_history_management.md)

