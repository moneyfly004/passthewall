# 工单管理功能说明

## 功能概述

工单管理功能用于处理用户提交的工单（客服工单），支持用户端提交工单和管理员端处理工单。工单系统提供了完整的客服支持流程。

## 访问路径

- **管理员后台** → **工单中心**
- **用户端** → **工单中心**

## 主要功能

### 1. 工单信息展示

列表显示以下工单信息：
- **工单编号**：系统生成的唯一工单编号（格式：TKT + 时间戳）
- **标题**：工单标题
- **类型**：工单类型（技术问题/账单问题/账户问题/其他）
- **状态**：工单状态（待处理/处理中/已解决/已关闭）
- **优先级**：工单优先级（低/普通/高/紧急）
- **创建时间**：工单创建时间
- **最后回复**：最后回复时间
- **未读回复数**：未读的回复数量（用户端显示）
- **操作**：可执行的操作按钮

### 2. 工单创建（用户端）

用户可以创建新工单：
1. 点击"创建工单"按钮
2. 填写工单信息：
   - **标题**：简要描述问题
   - **类型**：选择工单类型
   - **优先级**：选择优先级
   - **内容**：详细描述问题
3. 提交工单
4. 系统自动创建工单并发送通知

### 3. 工单处理（管理员端）

管理员可以处理工单：
- **查看工单**：查看工单详情和所有回复
- **回复工单**：回复用户的问题
- **修改状态**：修改工单状态（待处理/处理中/已解决/已关闭）
- **修改优先级**：调整工单优先级
- **关闭工单**：关闭已解决的工单

### 4. 工单回复（用户端）

用户可以回复工单：
- **查看工单**：查看工单详情和管理员回复
- **添加回复**：回复管理员的问题或补充信息
- **查看未读回复**：查看管理员的未读回复

### 5. 搜索和筛选

- **状态筛选**：按工单状态筛选（待处理/处理中/已解决/已关闭）
- **类型筛选**：按工单类型筛选
- **关键词搜索**：搜索工单标题或内容

### 6. 工单统计

管理员可以查看工单统计：
- **待处理工单**：需要处理的工单数量
- **处理中工单**：正在处理的工单数量
- **已解决工单**：已解决的工单数量
- **工单总数**：系统中的工单总数

## 工单流程

### 用户创建工单流程

```
1. 用户点击"创建工单"
   ↓
2. 填写工单信息
   - 标题
   - 类型
   - 优先级
   - 内容
   ↓
3. 提交工单
   ↓
4. 系统创建工单
   - 生成工单编号
   - 设置初始状态为"待处理"
   - 发送通知给管理员
   ↓
5. 等待管理员处理
```

### 工单处理流程

```
1. 管理员查看待处理工单
   ↓
2. 管理员回复工单
   - 修改状态为"处理中"
   - 添加回复内容
   ↓
3. 用户查看回复
   - 收到通知（如果有）
   - 查看管理员回复
   ↓
4. 用户回复（如果需要）
   - 补充信息或回答问题
   ↓
5. 管理员继续处理
   - 根据用户回复继续处理
   ↓
6. 问题解决
   - 管理员修改状态为"已解决"
   - 或用户确认问题已解决
   ↓
7. 关闭工单
   - 管理员或用户关闭工单
   - 状态变为"已关闭"
```

## 数据模型

### Ticket 模型

```go
type Ticket struct {
    ID          uint
    UserID      uint
    TicketNo    string    // 工单编号（唯一）
    Title       string    // 标题
    Content     string    // 内容
    Type        string    // 类型（technical/billing/account/other）
    Status      string    // 状态（pending/processing/resolved/closed）
    Priority    string    // 优先级（low/normal/high/urgent）
    CreatedAt   time.Time
    UpdatedAt   time.Time
    
    // 关系
    User    User
    Replies []TicketReply
}
```

### TicketReply 模型

```go
type TicketReply struct {
    ID          uint
    TicketID    uint
    UserID      uint
    Content     string    // 回复内容
    IsAdminReply bool    // 是否为管理员回复
    CreatedAt   time.Time
    
    // 关系
    Ticket Ticket
    User   User
}
```

## API 接口

### 获取工单列表（用户端）

```
GET /api/v1/users/tickets
```

**查询参数：**
- `page`: 页码
- `size`: 每页数量
- `status`: 状态筛选
- `type`: 类型筛选

### 获取工单列表（管理员端）

```
GET /api/v1/admin/tickets
```

### 创建工单

```
POST /api/v1/users/tickets
```

**请求体：**
```json
{
  "title": "工单标题",
  "type": "technical",
  "priority": "normal",
  "content": "工单内容"
}
```

### 获取工单详情

```
GET /api/v1/users/tickets/:id
GET /api/v1/admin/tickets/:id
```

### 添加工单回复

```
POST /api/v1/users/tickets/:id/replies
POST /api/v1/admin/tickets/:id/replies
```

**请求体：**
```json
{
  "content": "回复内容"
}
```

### 更新工单状态

```
PUT /api/v1/admin/tickets/:id/status
```

**请求体：**
```json
{
  "status": "processing"
}
```

## 使用场景

### 场景1：用户提交工单

1. 用户遇到问题需要帮助
2. 进入工单中心，点击"创建工单"
3. 填写工单信息（标题、类型、优先级、内容）
4. 提交工单
5. 等待管理员回复

### 场景2：管理员处理工单

1. 管理员查看待处理工单列表
2. 点击工单查看详情
3. 阅读用户问题
4. 回复工单，提供解决方案
5. 修改工单状态为"处理中"
6. 等待用户确认或继续回复

### 场景3：工单沟通

1. 用户和管理员通过工单回复进行沟通
2. 每次回复都会更新工单
3. 双方可以查看完整的对话历史
4. 直到问题解决

## 注意事项

1. **工单编号**：每个工单都有唯一的编号，用于标识和查找
2. **工单状态**：工单状态由管理员控制，用户只能查看
3. **回复通知**：系统可以配置回复通知，提醒用户或管理员有新回复
4. **工单关闭**：已关闭的工单不能继续回复，需要重新创建工单
5. **工单优先级**：优先级影响工单的处理顺序，紧急工单应优先处理

## 相关功能

- [用户列表管理](./user_list_management.md)
- [通知设置](./notification_settings.md)

