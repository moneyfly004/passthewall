# 设备管理功能说明

## 功能概述

设备管理是用户端的重要功能，用于查看和管理自己订阅下的所有设备。用户可以查看设备信息、删除设备、了解设备使用情况。

## 访问路径

- **用户端** → **设备管理**

## 主要功能

### 1. 设备信息展示

列表显示以下设备信息：
- **设备名称**：自动识别的设备名称（如：Shadowrocket - iPhone 15 Pro - iOS 17.0）
- **设备类型**：设备类型（移动设备/桌面设备/平板设备）
- **软件信息**：使用的代理软件名称和版本
- **操作系统**：操作系统名称和版本
- **IP地址**：设备当前或最后使用的IP地址
- **最后访问**：设备最后一次访问订阅的时间
- **访问次数**：设备访问订阅的总次数
- **操作**：删除设备按钮

### 2. 设备统计

页面顶部显示设备统计信息：
- **总设备数**：当前订阅下的设备总数
- **设备限制**：该订阅允许的最大设备数量
- **剩余设备数**：还可以添加的设备数量（设备限制 - 当前设备数）

### 3. 设备操作

- **删除设备**：删除不需要的设备，释放设备数量
  - 删除后，该设备需要重新添加才能使用订阅
  - 删除设备不会影响其他设备的使用

### 4. 设备识别原理

系统通过以下方式识别设备：

1. **User-Agent 解析**
   - 从 HTTP 请求头中获取 User-Agent
   - 解析出软件名称、版本、操作系统等信息

2. **设备哈希生成**
   - 基于 User-Agent、IP地址等信息生成唯一哈希
   - 哈希算法：SHA256
   - 相同设备和软件版本会生成相同的哈希

3. **设备信息提取**
   - 软件名称：Shadowrocket、Clash、v2rayN等
   - 操作系统：iOS、Android、Windows、macOS等
   - 设备型号：iPhone 15 Pro、Samsung Galaxy等
   - 设备品牌：Apple、Samsung等

### 5. 设备漫游机制

当同一设备在不同网络环境下访问时：

1. **问题场景**
   - 用户在家庭WiFi下使用设备
   - 切换到公司WiFi或使用代理后IP变化
   - 系统可能误识别为新设备

2. **解决方案**
   - 系统检查是否有相同 User-Agent 的设备
   - 如果找到，更新该设备的IP和Hash
   - 而不是创建新设备记录
   - 这确保了同一设备不会因IP变化而被重复计算

## 设备数量限制原理

### 限制机制

每个订阅都有设备数量限制（`DeviceLimit`），默认值为3。

### 限制逻辑

1. **设备未超限**
   - 当前设备数 < 设备限制
   - 新设备可以正常添加
   - 所有设备都可以正常使用

2. **设备达到限制**
   - 当前设备数 = 设备限制
   - 新设备无法添加
   - 已存在的设备可以正常使用

3. **设备超过限制**
   - 当前设备数 > 设备限制
   - 新设备无法添加
   - 系统采用"最近使用优先"策略：
     - 按最后访问时间排序
     - 取前 `DeviceLimit` 个设备作为"允许的设备"
     - 只有这 `DeviceLimit` 个设备可以使用订阅
     - 其他设备会被拒绝，需要删除旧设备后才能使用

### 设备优先级

当设备数超过限制时，系统按以下规则确定哪些设备可以使用：

1. **排序规则**：按 `last_access`（最后访问时间）降序排序
2. **允许列表**：取前 `DeviceLimit` 个设备
3. **动态更新**：每次设备访问时，都会更新 `last_access` 时间
4. **自动淘汰**：长时间未使用的设备会被自动排除在允许列表外

### 设备状态

- **is_active**：设备是否活跃
  - `true`：设备活跃，计入设备数
  - `false`：设备已禁用，不计入设备数

- **is_allowed**：设备是否被允许使用
  - `true`：设备被允许使用
  - `false`：设备被禁止使用

## 数据模型

### Device 模型

```go
type Device struct {
    ID                uint
    UserID            *int64
    SubscriptionID    uint
    DeviceHash        *string    // 设备哈希（唯一标识）
    DeviceUA          *string    // User-Agent
    DeviceName        *string    // 设备名称
    DeviceType        *string    // 设备类型（mobile/desktop/tablet）
    DeviceModel       *string    // 设备型号
    DeviceBrand       *string    // 设备品牌
    IPAddress         *string    // IP地址
    UserAgent         *string    // 完整User-Agent
    SoftwareName      *string    // 软件名称
    SoftwareVersion   *string    // 软件版本
    OSName            *string    // 操作系统
    OSVersion         *string    // 操作系统版本
    SubscriptionType  *string    // 订阅类型（clash/universal）
    IsActive          bool       // 是否活跃
    IsAllowed         bool       // 是否允许使用
    FirstSeen         *time.Time // 首次出现时间
    LastAccess        time.Time  // 最后访问时间
    LastSeen          *time.Time // 最后出现时间
    AccessCount       int        // 访问次数
    CreatedAt         time.Time
    UpdatedAt         time.Time
}
```

## API 接口

### 获取设备列表

```
GET /api/v1/users/devices
```

**查询参数：**
- `subscription_id`: 订阅ID（可选，不传则返回所有订阅的设备）

**响应示例：**
```json
{
  "success": true,
  "data": {
    "devices": [
      {
        "id": 1,
        "device_name": "Shadowrocket - iPhone 15 Pro - iOS 17.0",
        "device_type": "mobile",
        "software_name": "Shadowrocket",
        "software_version": "2.2.0",
        "os_name": "iOS",
        "os_version": "17.0",
        "ip_address": "192.168.1.100",
        "last_access": "2025-12-22 10:00:00",
        "access_count": 150
      }
    ],
    "total_devices": 3,
    "device_limit": 3,
    "remaining_devices": 0
  }
}
```

### 删除设备

```
DELETE /api/v1/users/devices/:id
```

**响应示例：**
```json
{
  "success": true,
  "message": "设备删除成功"
}
```

## 使用场景

### 场景1：查看设备使用情况

1. 进入设备管理页面
2. 查看所有设备列表
3. 了解每个设备的最后访问时间和访问次数
4. 识别不常用的设备

### 场景2：删除不用的设备

1. 找到不再使用的设备
2. 点击"删除"按钮
3. 确认删除
4. 设备被删除，释放设备数量
5. 可以添加新设备

### 场景3：设备超限处理

1. 当设备数达到限制时，无法添加新设备
2. 查看设备列表，找到不常用的设备
3. 删除不常用的设备
4. 释放设备数量后，可以添加新设备

### 场景4：更换设备

1. 旧设备不再使用
2. 删除旧设备
3. 在新设备上添加订阅
4. 新设备自动识别并添加

## 常见问题

### Q1: 为什么我的设备被识别为多个设备？

**A:** 可能的原因：
1. 使用了不同的代理软件
2. 软件版本不同
3. 系统误识别

**解决方案：**
- 删除重复的设备记录
- 确保使用相同的软件和版本

### Q2: 为什么删除设备后还是无法添加新设备？

**A:** 可能的原因：
1. 设备数仍然达到限制
2. 有其他未显示的不活跃设备

**解决方案：**
- 检查设备统计信息
- 联系管理员清理设备记录

### Q3: 设备显示"不在允许范围内"是什么意思？

**A:** 当设备数超过限制时，系统只允许最近使用的 `DeviceLimit` 个设备使用订阅。如果设备长时间未使用，会被排除在允许列表外。

**解决方案：**
- 删除不常用的设备
- 或者联系管理员增加设备限制

### Q4: 同一设备在不同网络下被识别为不同设备？

**A:** 系统已实现设备漫游机制，会自动识别相同 User-Agent 的设备。如果仍然出现问题，可能是：
1. User-Agent 发生变化
2. 软件版本不同

**解决方案：**
- 确保使用相同的软件和版本
- 如果问题持续，联系管理员

## 注意事项

1. **删除设备**：删除设备后，该设备需要重新添加才能使用订阅
2. **设备限制**：每个订阅都有设备数量限制，请合理管理设备
3. **设备识别**：系统基于 User-Agent 和 IP 识别设备，确保软件版本一致
4. **设备漫游**：系统支持设备漫游，同一设备在不同网络下不会重复计算
5. **设备优先级**：当设备超限时，系统采用"最近使用优先"策略

## 相关功能

- [订阅列表管理](./subscription_list_management.md)
- [用户列表管理](./user_list_management.md)

