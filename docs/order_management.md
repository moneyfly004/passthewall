# 订单管理功能说明

## 功能概述

订单管理功能用于管理系统中的所有订单记录，包括用户订单和管理员订单查看。订单记录了用户的套餐购买、充值等交易信息。

## 访问路径

- **管理员后台** → **订单管理** → **订单列表**
- **用户端** → **订单记录**

## 主要功能

### 1. 订单信息展示

列表显示以下订单信息：
- **订单号**：系统生成的唯一订单号
- **用户信息**：下单用户的邮箱和用户名
- **套餐信息**：购买的套餐名称和价格
- **支付方式**：使用的支付方式（支付宝、微信、银行卡等）
- **订单金额**：订单总金额
- **订单状态**：订单状态（待支付/已支付/已取消）
- **创建时间**：订单创建时间
- **支付时间**：订单支付时间（如果已支付）
- **操作**：可执行的操作按钮

### 2. 搜索和筛选

- **关键词搜索**：支持通过订单号、用户邮箱、用户名搜索
- **状态筛选**：按订单状态筛选（全部/待支付/已支付/已取消）
- **支付方式筛选**：按支付方式筛选
- **时间范围筛选**：按订单创建时间或支付时间筛选

### 3. 订单操作

- **查看详情**：查看订单的完整信息
- **标记为已支付**：手动将订单标记为已支付（用于线下支付等情况）
- **取消订单**：取消未支付的订单
- **导出订单**：导出订单数据为CSV文件

### 4. 订单统计

管理员可以查看订单统计信息：
- **总订单数**：系统中的订单总数
- **待支付订单**：待支付的订单数量
- **已支付订单**：已支付的订单数量
- **总收入**：所有已支付订单的总金额
- **今日收入**：今日已支付订单的总金额

## 订单流程

### 用户下单流程

```
1. 用户选择套餐
   ↓
2. 点击"购买"按钮
   ↓
3. 系统创建订单
   - 生成唯一订单号
   - 记录订单信息
   - 订单状态：待支付
   ↓
4. 跳转到支付页面
   ↓
5. 用户完成支付
   ↓
6. 支付回调处理
   - 验证支付结果
   - 更新订单状态为"已支付"
   - 更新用户余额或订阅信息
   ↓
7. 订单完成
```

### 订单状态

- **pending**：待支付
  - 订单已创建，等待用户支付
  - 可以取消订单
  - 可以手动标记为已支付

- **paid**：已支付
  - 用户已完成支付
  - 订单不可取消
  - 用户余额或订阅已更新

- **cancelled**：已取消
  - 订单被取消（用户取消或超时取消）
  - 订单不可恢复
  - 不会影响用户余额

## 数据模型

### Order 模型

```go
type Order struct {
    ID              uint
    UserID          uint
    PackageID       uint
    OrderNo         string    // 订单号（唯一）
    Amount          float64   // 订单金额
    PaymentMethod   string    // 支付方式
    PaymentMethodID uint      // 支付方式ID
    Status          string    // 订单状态（pending/paid/cancelled）
    PaymentTime      *time.Time // 支付时间
    CreatedAt       time.Time
    UpdatedAt       time.Time
    
    // 关系
    User    User
    Package Package
}
```

### Package 模型

```go
type Package struct {
    ID          uint
    Name        string    // 套餐名称
    Description string    // 套餐描述
    Price       float64   // 套餐价格
    Duration    int       // 套餐时长（天）
    DeviceLimit int       // 设备限制
    IsActive    bool      // 是否启用
    CreatedAt   time.Time
    UpdatedAt   time.Time
}
```

## API 接口

### 获取订单列表（管理员）

```
GET /api/v1/admin/orders
```

**查询参数：**
- `page`: 页码
- `size`: 每页数量
- `keyword`: 搜索关键词
- `status`: 状态筛选
- `payment_method`: 支付方式筛选
- `start_date`: 开始日期
- `end_date`: 结束日期

### 获取订单列表（用户）

```
GET /api/v1/users/orders
```

### 创建订单

```
POST /api/v1/orders/
```

**请求体：**
```json
{
  "package_id": 1,
  "payment_method_id": 1
}
```

### 标记订单为已支付

```
PUT /api/v1/admin/orders/:id/mark-paid
```

## 使用场景

### 场景1：查看订单详情

1. 在订单列表中找到目标订单
2. 点击订单号或"查看"按钮
3. 查看订单的完整信息：
   - 订单基本信息
   - 用户信息
   - 套餐信息
   - 支付信息
   - 订单状态变更历史

### 场景2：处理线下支付

1. 用户通过线下方式支付（如银行转账）
2. 管理员在订单列表中找到对应订单
3. 点击"标记为已支付"按钮
4. 系统更新订单状态和用户余额

### 场景3：订单统计

1. 进入订单管理页面
2. 查看订单统计信息
3. 了解系统收入情况
4. 可以按时间范围筛选统计

## 注意事项

1. **订单号唯一性**：每个订单都有唯一的订单号，用于支付回调验证
2. **支付回调**：支付完成后，支付平台会回调系统接口更新订单状态
3. **订单取消**：只有待支付状态的订单可以取消
4. **手动标记支付**：管理员可以手动标记订单为已支付，用于处理特殊情况
5. **订单不可删除**：订单记录不可删除，只能取消未支付的订单

## 相关功能

- [套餐管理](./package_management.md)
- [支付配置](./payment_config.md)

