# 登录历史管理功能说明

## 功能概述

登录历史功能用于记录和查看用户的登录记录，包括登录时间、IP地址、地区信息、设备信息等。该功能帮助用户和管理员了解账户的登录情况，提高账户安全性。

## 访问路径

- **用户端** → **个人资料** → **登录历史**
- **管理员端** → **个人资料** → **安全设置** → **登录历史**

## 主要功能

### 1. 登录记录展示

列表显示以下登录信息：
- **登录时间**：用户登录的具体时间
- **IP地址/地区**：登录时的IP地址和地理位置
  - IP地址：显示登录时的IP地址
  - 地区信息：显示IP地址对应的地理位置（国家、城市）
- **设备信息**：登录时使用的设备信息
  - 设备类型：移动设备/桌面设备/平板设备
  - 操作系统：iOS、Android、Windows、macOS等
  - 软件信息：使用的浏览器或客户端软件
- **状态**：登录状态（成功/失败）

### 2. 登录统计

页面显示登录统计信息：
- **总登录次数**：账户的总登录次数
- **不同IP数量**：登录时使用的不同IP地址数量
- **不同国家**：登录时所在的不同国家数量
- **距上次登录(天)**：距离最后一次登录的天数

### 3. 地区信息显示

系统会自动识别并显示登录地区：
- **本地IP**：127.0.0.1、::1、localhost 显示为"本地"
- **内网IP**：192.168.x.x、10.x.x.x、172.x.x.x 显示为"内网"
- **公网IP**：显示实际的国家和城市（如"中国, 北京"）

## 登录记录原理

### 记录流程

```
1. 用户登录系统
   ↓
2. 系统获取登录信息
   - IP地址：从请求头中获取真实IP
   - User-Agent：从请求头中获取
   - 登录时间：当前时间
   ↓
3. 解析地理位置（如果GeoIP已启用）
   - 使用GeoIP数据库解析IP地址
   - 获取国家、城市等信息
   ↓
4. 创建登录历史记录
   - 保存IP地址
   - 保存User-Agent
   - 保存地理位置信息
   - 保存登录状态（成功/失败）
   ↓
5. 记录到数据库
```

### 地理位置解析

系统使用 MaxMind GeoLite2 数据库解析IP地址：

1. **GeoIP数据库**
   - 数据库文件：`GeoLite2-City.mmdb`
   - 自动下载：系统启动时自动下载（如果不存在）
   - 手动更新：管理员可以在系统设置中更新数据库

2. **解析逻辑**
   - 本地IP（127.0.0.1）：直接标记为"本地"
   - 内网IP（192.168.x.x等）：直接标记为"内网"
   - 公网IP：使用GeoIP数据库解析
   - 解析失败：不显示地区信息

3. **地区信息格式**
   - JSON格式：`{"country": "中国", "city": "北京", ...}`
   - 逗号分隔：`中国, 北京`
   - 显示格式：`中国, 北京` 或 `中国`（如果没有城市信息）

### IP地址处理

系统会对IP地址进行标准化处理：

1. **IPv6处理**
   - `::1` → `127.0.0.1`（IPv6本地回环转换为IPv4）
   - `::ffff:127.0.0.1` → `127.0.0.1`（IPv6映射的IPv4地址）

2. **真实IP获取**
   - 优先从 `X-Forwarded-For` 头获取
   - 其次从 `X-Real-IP` 头获取
   - 最后从请求的RemoteAddr获取

## 数据模型

### LoginHistory 模型

```go
type LoginHistory struct {
    ID                uint
    UserID            uint
    LoginTime         time.Time  // 登录时间
    IPAddress         sql.NullString // IP地址
    UserAgent         sql.NullString // User-Agent
    Location          sql.NullString // 地理位置（JSON格式）
    LoginStatus       string     // 登录状态（success/failed）
    FailureReason     sql.NullString // 失败原因（如果登录失败）
    CreatedAt         time.Time
}
```

## API 接口

### 获取登录历史（用户端）

```
GET /api/v1/users/login-history
```

**响应示例：**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "login_time": "2025-12-22 10:00:00",
      "ip_address": "192.168.1.100",
      "user_agent": "Mozilla/5.0...",
      "location": "{\"country\":\"中国\",\"city\":\"北京\"}",
      "login_status": "success"
    }
  ]
}
```

### 获取登录历史（管理员端）

```
GET /api/v1/admin/login-history
```

## 使用场景

### 场景1：查看登录记录

1. 进入登录历史页面
2. 查看所有登录记录
3. 了解账户的登录情况
4. 检查是否有异常登录

### 场景2：识别异常登录

1. 查看登录记录中的IP地址和地区
2. 如果发现不熟悉的IP或地区
3. 可能是账户被盗用
4. 应立即修改密码并联系管理员

### 场景3：查看登录统计

1. 查看登录统计信息
2. 了解账户的活跃程度
3. 查看登录过的不同地区
4. 分析账户使用情况

## 安全建议

1. **定期检查**：定期查看登录历史，发现异常及时处理
2. **异地登录**：如果发现异地登录，立即修改密码
3. **设备识别**：注意登录设备信息，发现不熟悉的设备要警惕
4. **IP变化**：如果IP地址频繁变化，可能是账户安全问题
5. **登录失败**：如果发现大量登录失败记录，可能是暴力破解攻击

## 注意事项

1. **GeoIP数据库**：需要下载GeoIP数据库才能显示地区信息
2. **本地IP**：本地IP（127.0.0.1）会显示为"本地"，这是正常的
3. **内网IP**：内网IP会显示为"内网"，无法获取具体地理位置
4. **登录记录数量**：系统默认只显示最近50条登录记录
5. **记录保存**：登录记录会永久保存，用于安全审计

## 相关功能

- [用户列表管理](./user_list_management.md)
- [设备管理](./device_management.md)
- [GeoIP集成说明](./GeoIP集成说明.md)

