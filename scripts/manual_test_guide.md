# 手动测试专线节点流程指南

由于无法直接控制浏览器，请按照以下步骤手动测试：

## 准备工作

### 1. 确保服务运行
```bash
# 检查后端服务
ps aux | grep "go.*server"

# 检查前端服务
ps aux | grep "vite"
```

### 2. 获取管理员Token
1. 打开浏览器，访问管理后台
2. 登录管理员账号
3. 打开浏览器开发者工具（F12）
4. 在 Console 中执行：
```javascript
// 获取token
localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token')
```

---

## 测试步骤

### 第一步：配置系统设置

1. **打开系统设置页面**
   - 访问：`http://localhost:8080/admin/settings`
   - 切换到 "专线节点设置" 标签页

2. **填写配置信息**
   ```
   Cloudflare API Key: 3c81fa5339019d61bd4f180255fa74b2901e5
   Cloudflare 邮箱: 3219904322@qq.com
   证书申请邮箱: kdaisywendy@gmail.com
   ```

3. **保存配置**
   - 点击 "保存专线节点设置" 按钮
   - 等待成功提示
   - **重要**：刷新页面，检查配置是否还在

4. **验证保存**
   - 打开浏览器开发者工具（F12）
   - 切换到 Network 标签页
   - 刷新页面
   - 查看 `/api/v1/admin/settings` 请求
   - 检查响应中是否包含 `custom_node` 数据

---

### 第二步：测试服务器连接

1. **打开服务器管理页面**
   - 访问：`http://localhost:8080/admin/servers`

2. **检查服务器列表**
   - 确认您的VPS服务器在列表中
   - 检查服务器状态

3. **测试连接**
   - 点击服务器行的 "测试连接" 按钮
   - 等待测试完成
   - 确认显示 "连接测试成功"
   - 检查服务器状态是否变为 "活跃"

---

### 第三步：自动安装XrayR

1. **自动设置XrayR**
   - 在服务器列表中，找到要测试的服务器
   - 点击 "自动设置XrayR" 按钮
   - 确认操作提示
   - 等待系统自动完成（可能需要1-2分钟）

2. **检查安装状态**
   - 等待30秒后，刷新页面
   - 检查 "XrayR状态" 列，应该显示 "已安装"

3. **获取XrayR配置**
   - 点击 "获取配置" 按钮
   - 系统会自动读取XrayR配置并填写到系统设置中

4. **验证XrayR配置**
   - 前往 "系统设置" → "专线节点设置"
   - 检查 "XrayR API地址" 和 "XrayR API密钥" 是否已自动填写
   - 记录下这些信息

---

### 第四步：创建测试节点

1. **打开专线节点管理页面**
   - 访问：`http://localhost:8080/admin/custom-nodes`

2. **创建测试节点**
   - 点击 "创建专线节点" 按钮
   - 填写以下信息：
   
   **基本信息：**
   - 服务器：选择您测试的服务器
   - 节点名称：`测试节点-1`
   - 协议类型：选择 `VMess`

   **连接配置：**
   - 域名：留空（或填写您的域名）
   - 端口：点击 "随机生成" 按钮
   - UUID：点击 "随机生成" 按钮
   - 传输协议：选择 `TCP`
   - 安全设置：选择 `None`（如果不用域名）

   **限制设置：**
   - 流量限制：填写 `10`（10GB）
   - 到期时间：留空
   - 遵循用户到期：关闭

3. **保存节点**
   - 点击 "保存" 按钮
   - 系统会显示 "节点创建成功，正在自动搭建..."

4. **等待节点创建完成**
   - 节点创建是异步进行的，需要等待1-3分钟
   - 每30秒刷新一次页面
   - 检查节点状态，应该变为 "活跃"

---

### 第五步：分配节点给用户

1. **打开用户列表**
   - 访问：`http://localhost:8080/admin/users`

2. **选择测试用户**
   - 找到一个测试用户（或创建一个新用户）
   - 点击用户行的 "详情" 按钮

3. **分配节点**
   - 在用户详情对话框中，切换到 "专线节点分配" 标签页
   - 在 "分配新专线节点" 下拉框中选择刚创建的节点
   - 点击 "分配" 按钮

4. **验证分配**
   - 在 "已分配专线节点" 列表中，应该能看到刚分配的节点
   - 节点名称应该显示为 "专线定制-测试节点-1"

---

### 第六步：验证用户端订阅

1. **获取用户订阅链接**
   - 在用户详情中，找到订阅链接
   - 或让测试用户登录，获取订阅链接

2. **导入订阅到客户端**
   - 使用V2Ray客户端（如V2RayN、Clash等）
   - 导入订阅链接
   - 检查节点列表

3. **验证节点显示**
   - 在客户端中，应该能看到：
     - 普通节点（如果有）
     - 专线节点（名称以 "专线定制-" 开头）

4. **测试连接**
   - 选择专线节点
   - 尝试连接
   - 检查是否能正常使用

---

## 使用测试脚本（可选）

如果您想使用命令行测试，可以运行：

```bash
# 设置管理员token
export ADMIN_TOKEN="your_admin_token_here"

# 运行测试脚本
./scripts/test_custom_node.sh
```

---

## 调试技巧

### 查看浏览器控制台
1. 打开开发者工具（F12）
2. 切换到 Console 标签页
3. 查看是否有错误信息

### 查看网络请求
1. 打开开发者工具（F12）
2. 切换到 Network 标签页
3. 查看API请求和响应
4. 检查请求是否成功（状态码200）
5. 查看响应内容

### 查看后端日志
```bash
# 查看Go服务日志
tail -f logs/app.log
tail -f logs/error.log
```

### 查看服务器日志
```bash
# SSH到服务器
ssh user@server

# 查看XrayR日志
tail -f /var/log/XrayR/error.log
tail -f /var/log/XrayR/access.log

# 检查XrayR服务状态
systemctl status XrayR
```

---

## 常见问题排查

### 问题1：系统设置保存后刷新消失

**检查步骤：**
1. 打开浏览器开发者工具（F12）
2. 查看 Console 是否有错误
3. 查看 Network 标签页，检查保存请求：
   - 请求URL：`/api/v1/admin/configs/{key}`
   - 请求方法：PUT
   - 状态码：应该是200
   - 响应内容：应该包含 `"success": true`

**如果请求失败：**
- 检查请求体格式是否正确
- 检查category是否为 `custom_node`
- 查看后端日志获取详细错误

### 问题2：XrayR自动安装失败

**检查步骤：**
1. 确认服务器SSH连接正常（使用"测试连接"功能）
2. 检查服务器是否可以访问外网
3. 查看系统日志获取详细错误

**手动检查：**
```bash
# SSH到服务器
ssh user@server

# 检查网络连接
curl -I https://raw.githubusercontent.com

# 检查XrayR是否已安装
systemctl status XrayR
ls -la /etc/XrayR/config.yml
```

### 问题3：节点创建失败

**检查步骤：**
1. 查看节点状态是否为 "错误"
2. 打开浏览器控制台，查看错误信息
3. 检查XrayR API配置是否正确
4. 查看服务器上的XrayR日志

---

## 测试检查清单

- [ ] 系统设置可以保存
- [ ] 刷新后配置仍然存在
- [ ] 服务器连接测试成功
- [ ] XrayR自动安装成功
- [ ] XrayR配置自动获取成功
- [ ] 节点创建成功
- [ ] 节点状态为 "活跃"
- [ ] 节点可以分配给用户
- [ ] 用户订阅中包含专线节点
- [ ] 节点可以正常连接使用

---

**祝测试顺利！**


